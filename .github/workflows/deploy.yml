name: Deploy to Google Play

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: environment
      version_code:
        description: 'Version Code'
        required: true
        type: number

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check release branch
        if: ${{ !startsWith(github.ref, 'refs/heads/release/') }}
        run: |
          echo "::error::This workflow can only be run on release branches (e.g., release/1.0.0)"
          exit 1
          
      - name: Get version from branch
        id: get_version
        run: echo "version=${GITHUB_REF#refs/heads/release/}" >> $GITHUB_OUTPUT

      - name: Get version code
        id: get_version_code
        run: echo "version_code=${{ github.event.inputs.version_code }}" >> $GITHUB_OUTPUT
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true
          
      - name: Create secret.properties
        run: |
          echo "google.book.api.key=${{ secrets.GOOGLE_BOOK_API_KEY }}" > secret.properties
          
      - name: Create signing store file
        run: |
          echo "檢查 base64 字串長度："
          echo "${{ secrets.SIGNING_STORE_FILE_BASE64 }}" | wc -c
          echo "檢查 base64 字串格式："
          echo "${{ secrets.SIGNING_STORE_FILE_BASE64 }}" | grep -E '^[A-Za-z0-9+/]*={0,2}$'
          echo "解碼 base64 並檢查檔案大小："
          echo "${{ secrets.SIGNING_STORE_FILE_BASE64 }}" | tr -d '\n' | base64 -d > client/composeApp/signing_store.keystore
          ls -l client/composeApp/signing_store.keystore
          echo "檢查檔案是否為空："
          [ -s client/composeApp/signing_store.keystore ] && echo "檔案不為空" || echo "檔案為空"
          chmod 600 client/composeApp/signing_store.keystore

      - name: Check keystore
        run: |
          echo "檢查 keystore 內容："
          keytool -list -v -keystore client/composeApp/signing_store.keystore -storepass "${{ secrets.SIGNING_STORE_PASSWORD }}"
          echo "檢查 keystore 權限："
          ls -l client/composeApp/signing_store.keystore
          
      - name: Build Android App Bundle
        run: |
          ./gradlew clean bundle${{ vars.FLAVOR_NAME }} \
            -Pversion.code=${{ steps.get_version_code.outputs.version_code }} \
            -Pversion.name=${{ steps.get_version.outputs.version }} \
            -Psigning.store.file=signing_store.keystore \
            -Psigning.store.password=${{ secrets.SIGNING_STORE_PASSWORD }} \
            -Psigning.key.alias=${{ secrets.SIGNING_KEY_ALIAS }} \
            -Psigning.key.password=${{ secrets.SIGNING_KEY_PASSWORD }}
            
      - name: Output release files
        id: output_release_files
        run: |
          FLAVOR_NAME_LOWER=$(echo "${{ vars.FLAVOR_NAME }}" | awk '{print tolower($0)}')
          RELEASE_FILE="client/composeApp/build/outputs/bundle/${FLAVOR_NAME_LOWER}/composeApp-${FLAVOR_NAME_LOWER}.aab"
          echo "release_file=$RELEASE_FILE" >> $GITHUB_OUTPUT

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GCP_API_JSON_KEY }}
          packageName: ${{ vars.PACKAGE_NAME }}
          releaseFiles: ${{ steps.output_release_files.outputs.release_file }}
          track: internal
          status: completed
          changesNotSentForReview: false
          inAppUpdatePriority: 0

